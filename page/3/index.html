<!DOCTYPE html>
<html lang="en">
  <head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<link rel="alternate" href="/default" title="YangYao's blog"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0">
<link rel="canonical" href="http://yoursite.com/page/3/">

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css"><link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css">
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0">

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true,"latex":false};
</script>

    <title>YangYao's blog</title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">YangYao's blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">Home
          </li>
      </a><a href="/archives">
        <li class="mobile-menu-item">Archives
          </li>
      </a><a href="/tags">
        <li class="mobile-menu-item">Tags
          </li>
      </a><a href="/categories">
        <li class="mobile-menu-item">Categories
          </li>
      </a><a href="/about">
        <li class="mobile-menu-item">About
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">YangYao's blog</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            Home
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives">
            Archives
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            Tags
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            Categories
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/about">
            About
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><section id="posts" class="posts"><article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2019/09/30/2015-06-16-mongo-search-condition/">mongo的条件查询</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-09-30
        </span></div>
    </header>

    <div class="post-content"><p>##比较查询</p>
<p>$gt:大于</p>
<p>$lt:小于</p>
<p>$gte:大于或等于</p>
<p>$lte:小于或等于</p>
<p>$ne:不等于</p>
<p>###in查询</p>
<p><code>db.test.find({&quot;name&quot;:{&quot;$in&quot;:[&quot;stephen&quot;,&quot;stephen1&quot;]}})</code></p>
<p>php的用法： </p>
<p><code>$querys = [&quot;number&quot;=&gt;[&#39;$in&#39; =&gt; [1,2,9]]]</code></p>
<p>###not in 查询</p>
<p><code>db.test.find({&quot;name&quot;: {&quot;$not&quot;: {&quot;$in&quot;:[&quot;stephen2&quot;,&quot;stephen1&quot;]}}})</code></p>
<p>##关于字段值为null 或者为 “”或者不存在该字段的一些查询。</p>
<p>1.查询 不存在该字段或者值为null的记录</p>
<p><code>db.test.find({&quot;x&quot;:null})</code></p>
<p>2.查询 存在该字段并且值为null的记录</p>
<p><code>db.test.find({sex:{$in:[null],$exists:true}})</code></p>
<p>3.查询 存在该字段的记录</p>
<p><code>db.test.find({sex:{$exists:true}})</code></p>
<p>4.查询 空字符串</p>
<p><code>db.test.find({&quot;x&quot;:&#39;&#39;})</code></p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2019/09/30/2015-06-08-code-audit/">php代码审计学</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-09-30
        </span></div>
    </header>

    <div class="post-content"><h2 id="php代码审计"><a href="#php代码审计" class="headerlink" title="php代码审计"></a>php代码审计</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>代码审计学，通过对程序源码进行系统规范的检测，通过对源码的分析找到程序在设计开发阶段可以存在的漏洞和逻辑错误，避免程序被非法入侵，造成企业的风险。</p>
<h2 id="输入输出"><a href="#输入输出" class="headerlink" title="输入输出"></a>输入输出</h2><p>输入输出是用户是系统与用户接触最频繁的交互，也是最有可能形成漏洞的区域，如果我们对用户的输入过滤验证不严格，用户 就可以构造恶意语句形成漏洞，在处理输入输出时一定要保持 用户所用能控制的值都是不安全的 都必须要通过我们程序过滤判断处理。</p>
<ul>
<li>对数据进行精确匹配</li>
<li>接受白名单数据</li>
<li>拒绝黑名单数据</li>
<li>编码数据</li>
</ul>
<p>在php中可由用户输入的变量列表：</p>
<ul>
<li>$_SERVER</li>
<li>$_GET</li>
<li>$_POST</li>
<li>$_COOKIE</li>
<li>$_FILES</li>
<li>$_ENV</li>
<li>$_HTTP_COOKIE_VARS</li>
<li>$_HTTP_ENV_VARS</li>
<li>$_HTTP_GET_VARS</li>
<li>$_HTTP_POST_FILES</li>
<li>$_HTTP_POST_VARS</li>
<li>$_HTTP_SERVER_VARS</li>
</ul>
<h3 id="命令注入"><a href="#命令注入" class="headerlink" title="命令注入"></a>命令注入</h3><p>php中主要实现命令的函数有：</p>
<ul>
<li>system</li>
<li>exec</li>
<li>passthru</li>
<li>``</li>
<li>shell_exec</li>
<li>popen</li>
<li>proc_open</li>
<li>pcntl_exec </li>
</ul>
<p>审计中 我们通过批量搜索这些函数 对所带参数进行跟踪，判断是否过滤严格。</p>
<h3 id="跨站脚本"><a href="#跨站脚本" class="headerlink" title="跨站脚本"></a>跨站脚本</h3><p>反射型跨站常常出现在用户提交的变量接受以后经过处理，直接输出显示给客户端；存储型跨站常常出现在用户提交的变量接受过经过处理后，存储在数据库里，然后又从数据库中读取到此信息输出到客户端。</p>
<p>输出函数经常使用：</p>
<ul>
<li>echo</li>
<li>print</li>
<li>printf</li>
<li>vprintf</li>
<li>&lt;%=$test%&gt; </li>
</ul>
<p>对于反射型跨站，因为是立即输出显示给客户端，所以应该在当前的php页面检查变量被客户提交之后有无立即显示，在这个过程中变量是否有经过安全检查</p>
<h3 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h3><p>PHP可能出现文件包含的函数：</p>
<ul>
<li>include</li>
<li>include_once</li>
<li>require</li>
<li>require_once</li>
<li>show_source</li>
<li>highlight_file</li>
<li>readfile</li>
<li>file_get_contents</li>
<li>fopen</li>
<li>nt&gt;file</li>
</ul>
<h3 id="代码执行"><a href="#代码执行" class="headerlink" title="代码执行"></a>代码执行</h3><p>PHP可能出现代码注入的函数：</p>
<ul>
<li>eval</li>
<li>preg_replace+/e</li>
<li>assert</li>
<li>call_user_func</li>
<li>call_user_func_array</li>
<li>create_function</li>
</ul>
<h3 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h3><p>SQL注入因为要操作数据库，所以一般会查找SQL语句关键字：</p>
<ul>
<li>insert</li>
<li>delete</li>
<li>update</li>
<li>select</li>
</ul>
<h3 id="XPath注入"><a href="#XPath注入" class="headerlink" title="XPath注入"></a>XPath注入</h3><p>Xpath用于操作xml，我们通过搜索xpath来分析，提交给<fo nt face="Arial, sans-serif">xpath&lt;/fo 函数的参数是否有经过安全处理</fo></p>
<h3 id="HTTP响应拆分"><a href="#HTTP响应拆分" class="headerlink" title="HTTP响应拆分"></a>HTTP响应拆分</h3><p>PHP中可导致HTTP响应拆分的情况为：使用header函数和使用$_SERVER变量。注意PHP的高版本会禁止HTTP表头中出现换行字符，这类可以直接跳过本测试。</p>
<h3 id="文件管理"><a href="#文件管理" class="headerlink" title="文件管理"></a>文件管理</h3><p>PHP的用于文件管理的函数，如果输入变量可由用户提交，程序中也没有做数据验证，可能成为高危漏洞。我们应该在程序中搜索如下函数：</p>
<ul>
<li>copy</li>
<li>rmdir</li>
<li>unlink</li>
<li>delete</li>
<li>fwrite</li>
<li>chmod</li>
<li>fgetc</li>
<li>fgetcsv</li>
<li>fgets</li>
<li>fgetss</li>
<li>file</li>
<li>file_get_contents</li>
<li>fread</li>
<li>readfile</li>
<li>ftruncate</li>
<li>file_put_contents</li>
<li>fputcsv</li>
<li>fputs</li>
</ul>
<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><p>PHP文件上传通常会使用move_uploaded_file</p>
<h3 id="变量覆盖"><a href="#变量覆盖" class="headerlink" title="变量覆盖"></a>变量覆盖</h3><ol>
<li>遍历初始化变量 例： <code>foreach($_GET as $key =&gt; $value) $$key = $value;</code></li>
<li>函数覆盖变量：<ul>
<li>parse_str</li>
<li>mb_parse_str</li>
<li>import_request_variables </li>
</ul>
</li>
<li>Register_globals=ON时，GET方式提交变量会直接覆盖</li>
</ol>
<h3 id="动态函数"><a href="#动态函数" class="headerlink" title="动态函数"></a>动态函数</h3><p>当使用动态函数时，如果用户对变量可控，则可导致攻击者执行任意函数</p>
<h2 id="会话安全"><a href="#会话安全" class="headerlink" title="会话安全"></a>会话安全</h2><ul>
<li><p>HTTPOnly设置<br><br><code>session.cookie_httponly = ON 时，客户端脚本(JavaScript 等)无法访问该cookie，打开该
指令可以有效预防通过XSS 攻击劫持会话ID</code></p>
</li>
<li><p>domain 设置<br><br><code>检查session.cookie_domain 是否只包含本域，如果是父域，则其他子域能够获取本域的
cookies</code></p>
</li>
<li><p>path设置<br><br><code>检查session.cookie_path，如果网站本身应用在/app，则path 必须设置为/app/，才能保
证安全</code></p>
</li>
<li><p>cookies持续时间<br><br><code>检查session.cookie_lifetime，如果时间设置过程过长，即使用户关闭浏览器，攻击者也会
危害到帐户安全</code></p>
</li>
<li><p>secure设置<br><br><code>如果使用HTTPS，那么应该设置session.cookie_secure=ON，确保使用HTTPS 来传输
cookies</code></p>
</li>
<li><p>session固定<br><br><code>如果当权限级别改变时（例如核实用户名和密码后，普通用户提升到管理员），我们就应该
修改即将重新生成的会话ID ，否则程序会面临会话固定攻击的风险。</code></p>
</li>
<li><p>CSRF<br><br><code>跨站请求伪造攻击，是攻击者伪造一个恶意请求链接，通过各种方式让正常用户访问后，
会以用户的身份执行这些恶意的请求。我们应该对比较重要的程序模块，比如修改用户密码，添
加用户的功能进行审查，检查有无使用一次性令牌防御csrf 攻击。</code></p>
</li>
</ul>
<h2 id="加密解密"><a href="#加密解密" class="headerlink" title="加密解密"></a>加密解密</h2><ul>
<li><p>明文存储密码<br><br><code>采用明文的形式存储密码会严重威胁到用户、应用程序、系统安全。</code></p>
</li>
<li><p>密码弱加密<br><br><code>使用容易破解的加密算法，MD5加密已经部分可以利用md5破解网站来破解</code></p>
</li>
<li><p>密码存储在攻击者能访问到的文件<br><br><code>例如：保存密码在txt 、ini、conf、inc、xml 等文件中，或者直接写在HTML 注释中</code></p>
</li>
</ul>
<h2 id="认证和授权"><a href="#认证和授权" class="headerlink" title="认证和授权"></a>认证和授权</h2><ul>
<li><p>用户认证<br><br><code>检查代码进行用户认证的位置，是否能够绕过认证，例如：登录代码可能存在表单注入。检查登录代码有无使用验证码等，防止暴力破解的手段</code></p>
</li>
<li><p>函数或文件的未认证调用<br><br><code>一些管理页面是禁止普通用户访问的，有时开发者会忘记对这些文件进行权限验证，导致漏洞发生某些页面使用参数调用功能，没有经过权限验证，比如index.php?action=upload</code></p>
</li>
<li><p>密码硬编码<br><br><code>有的程序会把数据库链接账号和密码，直接写到数据库链接函数中。</code></p>
</li>
</ul>
<h2 id="随机函数"><a href="#随机函数" class="headerlink" title="随机函数"></a>随机函数</h2><ul>
<li><p>rand()<br><br><code>rand()最大随机数是32767，当使用rand 处理session 时，攻击者很容易破解出session，建议使用mt_rand()</code></p>
</li>
<li><p>mt_srand()和mt_rand()<br><br><code>PHP4和PHP5&lt;5.2.6，这两个函数处理数据是不安全的。在web 应用中很多使用mt_rand
来处理随机的session，比如密码找回功能等，这样的后果就是被攻击者恶意利用直接修改密码。</code></p>
</li>
</ul>
<!--
## 编码 ## 

## php危险函数 ##
-->

<h2 id="信息泄漏"><a href="#信息泄漏" class="headerlink" title="信息泄漏"></a>信息泄漏</h2><p>phpinfo()</p>
<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><ul>
<li>open_basedir 设置</li>
<li>allow_url_fopen 设置</li>
<li>allow_url_include设置</li>
<li>safe_mode_exec_dir 设置</li>
<li>magic_quote_gpc设置</li>
<li>register_globals设置</li>
<li>safe_mode 设置</li>
<li>session_use_trans_sid 设置</li>
<li>display_errors 设置</li>
<li>expose_php设置</li>
</ul>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2019/09/30/2014-08-13-nginx-stream/">nginx流媒体支持配置</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-09-30
        </span></div>
    </header>

    <div class="post-content"><p>##配置##<br>1：视频播放中实现拖拽效果，可以通过nginx配置http协议的流媒体<br>nginx编译过程中 需要加入mp4,flv流媒体模块的支持</p>
<blockquote>
</blockquote>
<p>–with-http_flv_module<br><br>–with-http_mp4_module</p>
<p>添加mp4,flv流媒体支持</p>
<blockquote>
</blockquote>
<p>location ~ .flv {<br><br>    root /data/wwwroot/;<br><br>    flv;<br><br>}</p>
<p>这样我们就能够实现对mp4和flv的流媒体支持了，可以实现 视频的拖拽效果</p>
<p>2：视频rtmp视频点播,直播协议的支持<br>下载nginx-rtmp-module模块<br>编译过程中添加</p>
<blockquote>
</blockquote>
<p>–add-module=/usr/src/nginx-rtmp-module-master –with-http_ssl_module –with-debug<br></p>
<p>点播配置：</p>
<blockquote>
</blockquote>
<p>rtmp {<br><br>    server {<br><br>    listen 1935;<br><br>    chunk_size 4000;<br><br>        application  vod {<br><br>            play /data/wwwroot/;<br><br>        }<br><br>    }<br><br>}</p>
<p>视频加载方式为 rtmp://xxx.xxx.xxx.xxx/play/视频路径<br>play代表rtmp提供的一个服务名</p>
<p>##盗链处理##<br>在处理视频资源文件安全型，保险一点的值能依靠视频的加密和播放器端解密的实现<br>服务器端 我们可以配合对访问来路判断，可以防止通过直接url下载视频资源</p>
<blockquote>
</blockquote>
<p>valid_referers blocked <a href="http://www.xxxx.com/paly.html" target="_blank" rel="noopener">www.xxxx.com/paly.html</a>;<br><br>if ($invalid_referer) <br><br>{<br><br>  return 403;<br><br>}<br></p>
<p>需要说明一点的是 迅雷和360点下载工具 他们在下载你资源时 它是会自己带Referer头 所以你如果不讲Referer指定一个具体的来路是限制不了他们的下载的</p>
<p>在配合我们struts 拦截器的帮助下 能够很好的实现资源的被盗链</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2019/09/30/2014-11-02-cors/">阿唐CORS代理服务</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-09-30
        </span></div>
    </header>

    <div class="post-content"><p>##什么是CORS##<br>cors代理可以让你的js跨域请求资源，解决js跨域的同源限制</p>
<p>##怎么使用CORS代理##<br>使用我们的代理方法非常的简单</p>
<ul>
<li>只需要在你请求的链接前加上我们代理域名：<a href="http://cors.itxti.net/" target="_blank" rel="noopener">http://cors.itxti.net/</a>?</li>
<li>例接口地址：<a href="http://www.xxx.com/getxxxx,当我们需要使用代理访问接口时，只需要拼接url，http://cors.itxti.net/?www.xxx.com/getxxxx" target="_blank" rel="noopener">www.xxx.com/getxxxx,当我们需要使用代理访问接口时，只需要拼接url，http://cors.itxti.net/?www.xxx.com/getxxxx</a> 形式即可。 </li>
<li>$(function(){ $.get(‘<a href="http://cors.itxti.net/?www.xxxxx.com?’,{pr:’1′,id:”},function(data){" target="_blank" rel="noopener">http://cors.itxti.net/?www.xxxxx.com?’,{pr:’1′,id:”},function(data){</a> ….. }); });</li>
</ul>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2019/09/30/2015-02-10-weixinpay/">微支付开发笔记</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-09-30
        </span></div>
    </header>

    <div class="post-content"><p>##概述##<br>越来越多的平台开始接入微信，通过微信这个平台，我们可以快速的接入移动互联网。<br>购物平台、人工收银系统、等，一个很关键的功能就是支付了，微信开发平台为我们提供一套支付系统。<br>微信支付平台分为两个版本：</p>
<pre><code>1:v2 (2014年9月10号之前申请的为v2版)
2:v3 (之后申请的为v3版)</code></pre><p>V3版的微信支付没有paySignKey参数</p>
<p>V2版中的参数有<br>AppID<br>AppSecret<br>支付专用签名串PaySignKey<br>商户号PartnerID<br>初始密钥PartnerKey</p>
<p>并且包含一个证书文件: 安全证书</p>
<p>V3版中的参数有<br>AppID<br>AppSecret<br>商户号PartnerID<br>初始密钥PartnerKey<br>商户号MCHID<br>申请编号<br>商户平台登录帐号<br>商户平台登录密码</p>
<p>包含5个证书文件（证书pkcs12格式、证书pem格式、证书密钥pem格式、CA证书， 安全证书）</p>
<p>##支付模式：</p>
<p>1.被扫支付<br>　　被扫支付是用户展示微信上“我的刷卡条码/二维码”给商户系统扫描后直接完成支付的模式。主要应用线下面对面收银的场景。</p>
<p>2.扫码支付<br>　　扫码支付是商户系统按微信支付协议生成支付二维码，用户再用微信“扫一扫”完成支付的模式。该模式适用于PC网站支付、实体店单品或订单支付、媒体广告支付等场景。</p>
<p>3.微信内网页支付<br>　　微信内网页支付是用户在微信中打开商户的H5页面，商户在H5页面通过调用微信支付提供的JSAPI接口调起微信支付模块完成支付。应用场景有：<br>　　　◆　用户在微信公众账号内进入商家公众号，打开某个主页面，完成支付<br>　　　◆　用户的好友在朋友圈、聊天窗口等分享商家页面连接，用户点击链接打开商家页面，完成支付<br>　　　◆　将商户页面转换成二维码，用户扫描二维码后在微信浏览器中打开页面后完成支付</p>
<p>4.APP支付<br>　　APP支付又称移动端支付，是商户通过在移动端应用APP中集成开放SDK调起微信支付模块完成支付的模式。</p>
<p>5.普通浏览器网页支付模式</p>
<p>phper可能以后会遇到的就是 网页支付(公众号支付)</p>
<p>网页支付，通过js 调用微信为我们封装好的支付组件（WeixinJSBridge）</p>
<pre><code>function onBridgeReady(){
   WeixinJSBridge.invoke(
       &apos;getBrandWCPayRequest&apos;, {
           &quot;appId&quot; : &quot;wx2421b1c4370ec43b&quot;,     //公众号名称，由商户传入    
           &quot;timeStamp&quot;:&quot; 1395712654&quot;,         //时间戳，自1970年以来的秒数    
           &quot;nonceStr&quot; : &quot;e61463f8efa94090b1f366cccfbbb444&quot;, //随机串    
           &quot;package&quot; : &quot;prepay_id=u802345jgfjsdfgsdg888&quot;,    
           &quot;signType&quot; : &quot;MD5&quot;,         //微信签名方式:    
           &quot;paySign&quot; : &quot;70EA570631E4BB79628FBCA90534C63FF7FADD89&quot; //微信签名
       },
       function(res){    
           if(res.err_msg == &quot;get_brand_wcpay_request:ok&quot; ) {}     // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。
       }
   );
}//调启函数
if (typeof WeixinJSBridge == &quot;undefined&quot;){如果不存在这个微信对象api
   if( document.addEventListener ){//开始注册这个对象
       document.addEventListener(&apos;WeixinJSBridgeReady&apos;, onBridgeReady, false);
   }else if (document.attachEvent){
       document.attachEvent(&apos;WeixinJSBridgeReady&apos;, onBridgeReady);
       document.attachEvent(&apos;onWeixinJSBridgeReady&apos;, onBridgeReady);
   }
}else{
   onBridgeReady();
}</code></pre><p>所以调起支付只需要我们组建好我们要传递给getBrandWCPayRequest对象的参数<br>一般我们可以在视图里用一个变量，表示我们组合好的参数,如</p>
<pre><code>WeixinJSBridge.invoke({&apos;getBrandWCPayRequest&apos;,{$parameter}});</code></pre><p>我们在在控制器里组合这些参数</p>
<pre><code> header(&quot;Expires : 0&quot;);
 header(&quot;Cache-Control : no-store,private, post-check=0, pre-check=0, max-age=0&quot;);
 header(&quot;Pragma : no-cache&quot;);
 //微信环境判断
 $agent = $_SERVER[&apos;HTTP_USER_AGENT&apos;];
 include_once(LIB_PATH.&quot;/Class/WxPay/WxPayPubHelper.php&quot;);
 $jsApi = new JsApi_pub();
 if (!isset($_GET[&apos;code&apos;]))
 {
     //触发微信返回code码
     $url = $jsApi-&gt;createOauthUrlForCode(WxPayConf_pub::JS_API_CALL_URL);//注意带上自己需要回调的参数
     Header(&quot;Location: $url&quot;);
 }else
 {
     //获取code码，以获取openid
     $code = $_GET[&apos;code&apos;];
     $jsApi-&gt;setCode($code);
     $openid = $jsApi-&gt;getOpenId();
 }

 //=========步骤2：使用统一支付接口，获取prepay_id============
 //使用统一支付接口
 $unifiedOrder = new UnifiedOrder_pub();

 //设置统一支付接口参数
 //设置必填参数
 //appid已填,商户无需重复填写
 //mch_id已填,商户无需重复填写
 //noncestr已填,商户无需重复填写
 //spbill_create_ip已填,商户无需重复填写
 //sign已填,商户无需重复填写
 $unifiedOrder-&gt;setParameter(&quot;openid&quot;,&quot;$openid&quot;);//商品描述
 $unifiedOrder-&gt;setParameter(&quot;body&quot;,&quot;微信安全支付&quot;);//商品描述
 //自定义订单号，此处仅作举例
 $timeStamp = time();
 //$out_trade_no = WxPayConf_pub::APPID.&quot;$timeStamp&quot;;
 $out_trade_no = $orderInfo[&apos;sn&apos;];
 $payamount = $orderInfo[&apos;payamount&apos;] * 100;
 //$payamount = 1;//测试用金额
 $unifiedOrder-&gt;setParameter(&quot;out_trade_no&quot;,&quot;$out_trade_no&quot;);//商户订单号
 //$unifiedOrder-&gt;setParameter(&quot;total_fee&quot;,$orderInfop[&apos;payamount&apos;]);//总金额
 $unifiedOrder-&gt;setParameter(&quot;total_fee&quot;,&quot;$payamount&quot;);//总金额
 $unifiedOrder-&gt;setParameter(&quot;notify_url&quot;,WxPayConf_pub::NOTIFY_URL);//通知地址
 $unifiedOrder-&gt;setParameter(&quot;trade_type&quot;,&quot;JSAPI&quot;);//交易类型
 //非必填参数，商户可根据实际情况选填
 //$unifiedOrder-&gt;setParameter(&quot;sub_mch_id&quot;,&quot;XXXX&quot;);//子商户号 
 //$unifiedOrder-&gt;setParameter(&quot;device_info&quot;,&quot;XXXX&quot;);//设备号
 //$unifiedOrder-&gt;setParameter(&quot;attach&quot;,&quot;XXXX&quot;);//附加数据
 //$unifiedOrder-&gt;setParameter(&quot;time_start&quot;,&quot;XXXX&quot;);//交易起始时间
 //$unifiedOrder-&gt;setParameter(&quot;time_expire&quot;,&quot;XXXX&quot;);//交易结束时间
 //$unifiedOrder-&gt;setParameter(&quot;goods_tag&quot;,&quot;XXXX&quot;);//商品标记
 //$unifiedOrder-&gt;setParameter(&quot;openid&quot;,&quot;XXXX&quot;);//用户标识
 //$unifiedOrder-&gt;setParameter(&quot;product_id&quot;,&quot;XXXX&quot;);//商品ID

 $prepay_id = $unifiedOrder-&gt;getPrepayId();
 //=========步骤3：使用jsapi调起支付============
 $jsApi-&gt;setPrepayId($prepay_id);

 $jsApiParameters = $jsApi-&gt;getParameters();
 $this-&gt;assign(&apos;parameter&apos;,$jsApiParameters);
//加载视图</code></pre><p>大致流程为：</p>
<ul>
<li>获取用户openid，通过接口OAuth2.0形式获取<br>获取code，如果code为空跳转获取，通过code像微信服务器换取accesstoken，在通过accesstoken换取用户信息<br>我们通过微信的sdk可以很简单的做到这点<br>pic</li>
<li>设置商品基本信息，生成package参数</li>
<li>通过支付密钥加密生成签名paySign<br>生成paySign过程：<br>拼接所以需要传递的字段<br>在最后加入key=商家密钥进行md5加密<br>假设传送的参数如下：<br>appid： wxd930ea5d5a258f4f<br>mch_id： 10000100<br>device_info： 1000<br>body： test<br>nonce_str： ibuaiVcKdpRxkhJA</li>
</ul>
<p>第一步：对参数按照key=value的格式，并按照参数名ASCII字典序排序如下：<br>stringA=”appid=wxd930ea5d5a258f4f&amp;body=test&amp;device_info=1000&amp;mch_id=10000100&amp;nonce_str=ibuaiVcKdpRxkhJA”;<br>第二步：拼接API密钥：<br>stringSignTemp=”stringA&amp;key=192006250b4c09247ec02edce69f6a2d”<br>sign=MD5(stringSignTemp).toUpperCase()=”9A0A8659F005D6984697E2CA0A9CF3B7”<br>最终得到最终发送的数据：</p>
<p>wxd930ea5d5a258f4f<br>10000100<br>1000<br>test<br>ibuaiVcKdpRxkhJA<br>9A0A8659F005D6984697E2CA0A9CF3B7</p>
<p>至此发起支付的工作基本就ok了</p>
<p>其次还有一个重要的步骤就是 对支付结果的处理<br>我们在发起支付时 会给微信服务器传递一个通知接口，在支持成功后微信服务会将这个接口post支付通知</p>
<p>支付回调:</p>
<pre><code>public function payNotify(){
    include_once(LIB_PATH.&quot;/Class/WxPay/WxPayPubHelper.php&quot;);
    $notify = new Notify_pub();
    //存储微信的回调
    $xml = $GLOBALS[&apos;HTTP_RAW_POST_DATA&apos;]; 
    $notify-&gt;saveData($xml);
    $data = $notify-&gt;getData();
    if($notify-&gt;checkSign() == FALSE){
        $notify-&gt;setReturnParameter(&quot;return_code&quot;,&quot;FAIL&quot;);//返回状态码
        $notify-&gt;setReturnParameter(&quot;return_msg&quot;,&quot;签名失败&quot;);//返回信息
        Log::write(&apos;签名验证失败&apos;);
    }else{
        //支付成功业务处理


        $notify-&gt;setReturnParameter(&quot;return_code&quot;,&quot;SUCCESS&quot;);//设置返回码
    }
    $returnXml = $notify-&gt;returnXml();
    echo $returnXml;
}</code></pre>
        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2019/09/30/tets/">tets</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-09-30
        </span></div>
    </header>

    <div class="post-content">
        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2019/09/30/hello-world/">Hello World</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-09-30
        </span></div>
    </header>

    <div class="post-content"><p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2015/06/15/2015-06-15-githube5858de5af86e7a081pushe79a84e696b9e6b395/">github免密码push的方法</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-06-15
        </span><span class="post-category">
            <a href="/categories/CodeIgniter/">CodeIgniter</a>
            </span>
        </div>
    </header>

    <div class="post-content"><p>1.生成ssh key</p>
<p>ssh-keygen -t rsa -C <a href="mailto:%26quot;your_email@example.com%26quot;" target="_blank" rel="noopener">“your_email@example.com”</a></p>
<p>2.添加到github</p>
<p>3.校验ssh key</p>
<p>ssh -T <a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a></p>
<p>4.修改配置</p>
<p>url 改成ssh的，而不是https的</p>
<p>[remote “origin”]  </p>
<p>url = <a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a>:yangyao/yangyao.git  </p>
<p>5.以后避免</p>
<p>clone的时候就要选择ssh的url</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2015/06/15/2015-06-15-mongoe79a84e69da1e4bbb6e69fa5e8afa2/">mongo的条件查询</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-06-15
        </span><span class="post-category">
            <a href="/categories/CodeIgniter/">CodeIgniter</a>
            </span>
        </div>
    </header>

    <div class="post-content"><p>##比较查询</p>
<p>$gt:大于  </p>
<p>$lt:小于  </p>
<p>$gte:大于或等于  </p>
<p>$lte:小于或等于</p>
<p>$ne:不等于</p>
<p>###in查询</p>
<p><code>db.test.find({&quot;name&quot;:{&quot;$in&quot;:[&quot;stephen&quot;,&quot;stephen1&quot;]}})</code></p>
<p>php的用法： <code>$querys = [&quot;number&quot;=&gt;[&#39;$in&#39; =&gt; [1,2,9]]]</code></p>
<p>###not in 查询</p>
<p><code>db.test.find({&quot;name&quot;: {&quot;$not&quot;: {&quot;$in&quot;:[&quot;stephen2&quot;,&quot;stephen1&quot;]}}})</code></p>
<p><strong>##关于字段值为null 或者为 “”或者不存在该字段的一些查询。</strong></p>
<p>1.查询 不存在该字段或者值为null的记录</p>
<p><code>db.test.find({&quot;x&quot;:null})</code></p>
<p>2.查询 存在该字段并且值为null的记录</p>
<p><code>db.test.find({sex:{$in:[null],$exists:true}})</code></p>
<p>3.查询 存在该字段的记录</p>
<p><code>db.test.find({sex:{$exists:true}})</code></p>
<p>4.查询 空字符串</p>
<p><code>db.test.find({&quot;x&quot;:&#39;&#39;})</code></p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2015/06/10/2015-06-10-php-artisane69fa5e79c8be697a5e5bf97/">php artisan查看日志</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-06-10
        </span><span class="post-category">
            <a href="/categories/CodeIgniter/">CodeIgniter</a>
            </span>
        </div>
    </header>

    <div class="post-content"><p>php artisan tail –path /var/www/fitshike2/app/storage/logs/plain.log</p>

        </div></article>
      <nav class="pagination"><a class="prev" href="/page/2/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text">Prev</span>
      </a>
    <a class="next" href="/page/4/">
        <span class="next-text">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></section></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
        <a href="https://github.com/ahonn" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2015 - 2019<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">John Doe</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
